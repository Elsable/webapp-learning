### マイグレーション系

- 1 度エラーが出ると連鎖的におかしなことが起きることがある

複数の変更を一気に行っている時に途中でエラーが起きるとこれがある。  
原因  
`rails db:migrate`をしたときの rails 側での実行状態はロールバックされる、つまり一度成功した所もやり直している
一方でデータベース側はもう変更が反映されている状態になっていることがあって、そこの整合性が取れていないせいで失敗する。

対策としてはデータベースを直接叩いて既に反映されてしまった変更分を消してから`rails db:migrate`を走らせるとかが良い。  
力技としてマイグレーションファイルから既に反映済みの変更を消すとかもありうるが、これをやってしまうと自分の環境では良くても
別の環境でマイグレーションをしたときにほぼ確実に何か悪いことが起きてしまう。

- マイグレーションファイルの書き方

データベースの基礎が分かっていないとなんだかんだで書けない。  
データベースの正規化(第三正規形くらいまでやるといいらしい)をすると foreign key の設定などがわかるような気がする。  
あんまり生の SQL 書いているのと変わらないんだなあと最近知りました。

### コントローラ系

- ストロングパラメータ(多分大丈夫な気がするけど)

フロントからリクエストが飛んでくるときは変数 params にリクエストパラメータが格納されているが、これをコントローラで
直接いじってしまうとセキュリティホールを生む可能性があるのでストロングパラメータという記法を使わないといけない。

記法としては

```ruby
class HogeHogeController < ApplicationController
  ...
private
  def hogehoge_params
    params.require(:piyopiyo).permit(:param1, :param2, etc.)
  end
end
```

みたいな感じ(ちょっと間違っているかもです)  
この時、params は構造としてはハッシュになっていて、

```
{
  :id => 3,
  :token => "(適当な文字列)",
  :piyopiyo => {
    :param1 => "hogehoge",
    :param2 => "mogemoge",
    etc.
    }
}
```

みたいになっていて require の方でネストされたハッシュの一段回目のキーを指定してパラメータをとっていて、permit の方は
ネストされたハッシュの二段階目のキーを指定している。なので`:id`の値とかが欲しかったら

```ruby
params.require(:id)
```

だけで良かったはずです。他にも require されるパラメータの中身が Array だった場合の対処法などもあって少しごちゃごちゃしているので
調べたほうがいいかもです。

- フィルタをかける

認証系の話は結構簡単に書けるようになっています。  
あるメソッドを実行するときに権限などでフィルタしたかったらコントローラの最初のほうで`before_action:`を使うと書けます

http://ruby-rails.hatenadiary.com/entry/20141129/1417223453

### ルーター関連

- 魔法の言葉、resources

`resources: :members`みたいなことを書いておくと結構便利なんですがわりとルーティングがブラックボックスなので
ちょっとつらかったです(まだあんま理解していない)。特にあるテーブルに 1 レコード作成するごとに別のテーブルではそれに応じて
複数レコードが生成されるパターンなんかだとあんまりこれを使わないほうがいい気もしました。

https://railsguides.jp/routing.html

### DB 関連

- リレーションに応じてテーブル名が決まることがある

Rails だとテーブル間に適切にリレーションが設定してあることによって、表向きは結合処理をしていないような書き方を
しても別テーブルにあるレコードを簡単に呼び出せたりできることがあります。

例)

受注内訳テーブルに(受注 ID, 商品 ID, 個数)が入っていて、商品テーブルに(商品 ID, 単価)が入っているような
設計の時、受注 ID ごとの総売上を計算したかったら

```sql
select sum(個数*単価) from 受注内訳 t1
  inner join 商品 t2 on t1.商品ID = t2.商品ID
  where 受注ID = 1;
```

みたいなことを書く必要があってテーブルの結合処理が挟まっているわけですが、rails だとリーレーションがあると、
商品テーブルの単価を受注内訳テーブルの要素みたいに扱えるようになっていたりして表向きは結合処理を書かなくても
よしなにしてくれます。

その上で、ちょっと複雑なデータベース構造の時に２つのテーブルの主キーだけを扱うような中間テーブルを作成する
ことがありますが、この時中間テーブルの名前に２つのテーブルの名前をアンダースコアで繋いだような名前にしないと
いけないみたいな話があった気がします。
